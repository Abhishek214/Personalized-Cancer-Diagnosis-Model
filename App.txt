# Updated /secret-receipt endpoint in Application.py
# Replace the existing secret-receipt endpoint with this version

@app.post("/secret-receipt", status_code=200, description="Getting the secret keys")
async def secret_receipt(secretName: str = Form(), secretValue: str = Form(), Content_Type: str = Header()):
    print(f"secretName : {secretName} (PID: {os.getpid()})")

    """
    Write data to config
    """
    if secretName and secretValue:
        if secretName == "dcrestai-gb-dcrest-svc-aco-doctager-pwd":
            set_global_data("dcrestai-gb-dcrest-svc-aco-doctager-pwd", secretValue)
            print(f"Received password for dcrestai-gb-dcrest-svc-aco-doctager-pwd (PID: {os.getpid()})")

            # Check if any model file exists as a quick check
            # The actual complete check will be done in download_models
            model_marker_file = "/tmp/model_download.complete"
            quick_check_file = "/tmp/ssd_512_resnet101_v2_voc-2cc0f93e.params"
            
            if not os.path.exists(quick_check_file) and not os.path.exists(model_marker_file):
                print(f"Models not found, initiating download (PID: {os.getpid()})")
                try:
                    download_models("dcrestai-gb-dcrest-svc-aco-doctager-pwd")
                except Exception as e:
                    print(f"Error downloading models: {e}")
                    # Don't fail the request, let other workers try
            else:
                print(f"Models appear to be present or download in progress, skipping download (PID: {os.getpid()})")

        # Model loading logic
        if "dcrestai-gb-dcrest-svc-aco-pwd" in get_all_global_data().keys():
            if "dcrestai-gb-svceco-doctage-pwd" in get_all_global_data().keys():
                model = get_model()
                if "session" not in model:
                    # Add a small delay for other workers to allow model download to complete
                    import time
                    time.sleep(2)
                    
                    # Check if models are downloaded before trying to load
                    if os.path.exists("/tmp/ssd_512_resnet101_v2_voc-2cc0f93e.params"):
                        try:
                            load_model()
                            print(f"Model loaded successfully (PID: {os.getpid()})")
                        except Exception as e:
                            print(f"Error loading model: {e} (PID: {os.getpid()})")
                    else:
                        print(f"Model files not yet available for loading (PID: {os.getpid()})")
                else:
                    print(f"Model already loaded. Skipping model loading. (PID: {os.getpid()})")

    # return the secret
    return secretName, secretValue
